# **NoraORM 项目文档**

## **项目由来**

NoraORM 诞生于一个温馨且个人的愿望之中。这个项目不仅仅是一个技术产物，它更是一位父亲对未来的一份期待和礼物。项目的名字来源于他女儿的名字“Nora”，寄托着他希望女儿在成长的道路上，有一天能够偶然发现这个项目，并从中感受到惊喜和父爱。NoraORM 是一个为 sqlite3 设计的数据库 ORM，它结合了同步和异步查询的能力，提供了一个高效、简便的方式来处理数据库操作。通过对象映射，用户能够迅速组装查询条件，进而高效地执行数据库查询，并准确返回结果。NoraORM 不仅为开发者提供了强大的后端支持，而且它的设计允许它与 Flask 这样的 Web 框架无缝集成，正如在 TNTDockerPanel 项目中的应用。

## **项目特性**

- **同步查询**：提供灵活的同步查询方法以简化使用，满足轻量级应用场景。
- **异步查询**：运行数据库操作时不会阻塞主线程，提高 I/O 密集型应用程序的性能。
- **对象关系映射**：快速书写数据库查询方法，自动转化为相应的 SQL 语句。
- **Flask 集成**：设计上兼容 Flask，易于在 Web 应用中集成使用。
- **简洁的 API**：API 设计直观简洁，易于上手和使用。
- **灵活性**：可以轻松扩展以支持更多的自定义功能和查询逻辑。
- **轻量级**：作为一个轻量级 ORM，它不会给您的应用程序带来沉重的负担。
- **线程与队列**：使用后台线程处理数据库操作，将它们放入队列中按收到的顺序执行。
- **回调支持**：提供回调机制在数据库操作完成后执行自定义函数。
- **线程安全连接**：配置允许在多个线程中使用 SQLite 连接。
- **优雅关闭**：确保在程序退出前完成所有数据库操作，防止数据丢失或损坏。

## **项目结构**

NoraORM 项目的结构如下所示：

- `noraorm/`：主要的包目录。
  - `__init__.py`：初始化脚本，包含基础配置。
  - `NoraORM.py`：异步支持模块，提供异步数据库操作能力。
- `tests/`：包含所有测试脚本和用例。
- `examples/`：提供一些实际应用示例，帮助理解如何在项目中使用 NoraORM。
- `requirements.txt`：列出所有依赖项。
- `setup.py`：安装脚本，用于安装 NoraORM 包。

## **项目逻辑**

1. **导入必需的模块**：
   - `sqlite3`：用于 SQLite 数据库操作。
   - `queue`：提供队列支持，用于异步操作。
   - `threading`：支持多线程，用于异步数据库操作。
   - `atexit`：注册退出时的回调函数。
   - `Error, Connection, Cursor`：从`sqlite3`模块导入，用于异常处理和数据库操作。
   - `Optional, List, Dict, Any, Tuple`：从`typing`模块导入，用于类型注解，提高代码可读性和健壮性。

2. **DatabaseOperation 类**：定义数据库操作的相关信息，包括操作方法、参数、关键字参数、回调函数和同步事件。

3. **DatabaseWorker 类（继承自 threading.Thread）**：
   - 用于在后台线程中处理数据库操作请求。
   - 通过队列接收`DatabaseOperation`实例，并执行相应的数据库方法。
   - 支持异常处理和回调函数调用。
   - 提供`perform`方法将操作加入队列，`close`方法用于优雅地关闭工作线程。

4. **NoraORM 类**：
   - ORM 的主体类，初始化时创建数据库连接和工作线程。
   - 提供`shutdown`方法用于关闭数据库连接和工作线程，通过`atexit`注册以确保程序退出时被调用。
   - 包含基本的数据库操作方法（增删改查），例如`pdo_get`、`pdo_insert`、`pdo_update`、`pdo_delete`。
   - 查询方法支持条件过滤、字段选择和排序。
   - 提供`execute_in_queue`和`execute_sync`方法支持异步和同步执行数据库操作。

**总结**：这段代码展示了如何结合 SQLite、多线程和队列实现一个支持异步操作的简单 ORM 系统。通过将数据库操作封装在后台线程中，可以提高应用程序的响应性和性能。

## **如何结合 Flask**

NoraORM 可以轻松集成到 Flask 应用中。首先，在 Flask 应用初始化时，配置 NoraORM 实例，并确保数据库连接参数正确。然后，在 Flask 视图函数中，通过 NoraORM 实例进行数据库操作，如查询、插入、更新或删除记录。

```python
from flask import Flask
from noraorm import NoraORM

app = Flask(__name__)
orm = NoraORM('path_to_sqlite_db')

@app.route('/users/<int:user_id>')
def get_user(user_id):
    user = orm.get(user_id)
    return user.to_json()
```

## **项目用例**

项目用例在`tests/`目录中提供，包括如何执行增删改查操作的示例。用户可以参考这些用例了解如何在自己的项目中应用 NoraORM。

## **项目捐赠**

如果您认为 NoraORM 对您有帮助，并希望支持项目的持续发展，或者想要给我女儿增添一件漂亮的公主裙，都可以通过以下方式进行捐赠：

<div align="center">
  <div style="display: inline-block; margin: 0 10px;">
    <img src="doc/paypal.jpg" alt="PayPal打赏二维码" width="100">
    <p>PayPal打赏二维码</p>
  </div>
  <div style="display: inline-block; margin: 0 10px;">
    <img src="doc/alipay.png" alt="支付宝打赏二维码" width="100">
    <p>支付宝打赏二维码</p>
  </div>
  <div style="display: inline-block; margin: 0 10px;">
    <img src="doc/wechatpay.jpg" alt="微信打赏二维码" width="100">
    <p>微信打赏二维码</p>
  </div>
</div>

## **注意事项和考虑因素**

- **数据库连接**：ORM 使用单个连接对象；确保您的数据库操作是线程安全的。
- **错误处理**：在您的回调函数中实现适当的错误处理非常重要，以处理任何数据库操作错误。
- **性能**：虽然 ORM 帮助避免了主线程的阻塞，但实际性能提升取决于您的应用程序性质和数据库大小。
- **日志记录**：建议为您的应用程序设置日志记录，以捕获数据库操作过程中可能发生的任何问题。

## **如何贡献**

NoraORM 欢迎社区成员的贡献，您可以通过以下方式参与项目建设：

- 提交问题报告。
- 提出功能请求。
- 提交拉取请求（PR）来修复错误或添加新功能。

在为 NoraORM 贡献代码之前，请确保阅读`CONTRIBUTING.md`文件，以了解提交指南和代码风格要求。

## **项目版权**

NoraORM 根据 MIT 许可证发布。这意味着您可以自由地使用、复制、修改和分发此软件。但是，您必须包含原始版权和许可声明。完整的许可证文本包含在项目的`LICENSE`文件中。

## **结束语**

NoraORM 的每一行代码都是为了提供一个更加优雅和高效的方式来处理数据库操作，同时也是一个父亲对女儿的爱的见证。我们希望这个项目不仅能够成为一个有用的工具，也能够传递出其背后的温暖故事。